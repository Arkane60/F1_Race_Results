<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>F1 Stats Explorer</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="/static/favicon.ico">
    <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
</head>
<body>
<div class="container">
    <h1>F1 Stats Explorer</h1>

    <!-- Controls for selecting the year -->
    <div class="controls">
        <label for="season">Select the year :</label>
        <select id="season"></select>
        <button onclick="loadData()">Load</button>
    </div>

    <!-- Driver standings table -->
    <h2>Driver Standings</h2>
    <div id="drivers-table"></div>

    <!-- Constructor standings table -->
    <h2>Constructor Standings</h2>
    <div id="constructors-table"></div>

    <!-- Points evolution graph -->
    <h2>Points evolution race by race</h2>
    <div id="points-graph"></div>

    <!-- Pilot statistics table -->
    <h2>Pilot statistics (wins, podiums, retirements)</h2>
    <div id="stats-table"></div>
</div>

<script>
// ----------------------
// Initialization
// ----------------------
const seasonSelect = document.getElementById("season");
const currentYear = new Date().getFullYear();

// Populate the year dropdown from currentYear down to 1950
for (let y = currentYear; y >= 1950; y--) {
    let opt = document.createElement("option");
    opt.value = y;
    opt.text = y;
    seasonSelect.appendChild(opt);
}

// ----------------------
// Load data from API
// ----------------------
async function loadData() {
    const season = seasonSelect.value;

    // Driver standings
    let res = await fetch(`/standings/drivers?season=${season}`);
    displayDriverStandings(await res.json());

    // Constructor standings
    res = await fetch(`/standings/constructors?season=${season}`);
    displayConstructorStandings(await res.json());

    // Points evolution
    res = await fetch(`/races/points?season=${season}`);
    displayPointsGraph(await res.json());

    // Pilot statistics
    res = await fetch(`/stats/pilots?season=${season}`);
    displayPilotStats(await res.json());
}

// ----------------------
// Display functions
// ----------------------

// Populate driver standings table
function displayDriverStandings(data) {
    const tableDiv = document.getElementById("drivers-table");

    let html = "<table><tr><th>Position</th><th>Driver</th><th>Points</th></tr>";

    for (let d of data) {
        let name = d.Driver.givenName + " " + d.Driver.familyName;
        html += `<tr>
                    <td>${d.position || "-"}</td>
                    <td>${name}</td>
                    <td>${d.points || 0}</td>
                 </tr>`;
    }

    html += "</table>";
    tableDiv.innerHTML = html;
}

// Populate constructor standings table
function displayConstructorStandings(data) {
    const tableDiv = document.getElementById("constructors-table");

    let html = "<table><tr><th>Position</th><th>Constructor</th><th>Points</th></tr>";

    for (let c of data) {
        html += `<tr>
                    <td>${c.position || "-"}</td>
                    <td>${c.Constructor.name}</td>
                    <td>${c.points || 0}</td>
                 </tr>`;
    }

    html += "</table>";
    tableDiv.innerHTML = html;
}

// Display points evolution graph using Plotly
function displayPointsGraph(pointsData) {
    let races = Object.keys(pointsData);
    races.sort((a, b) => new Date(b) - new Date(a));

    const drivers = new Set();
    for (let r of races) Object.keys(pointsData[r]).forEach(d => drivers.add(d));

    let traces = [];
    drivers.forEach(driver => {
        let lastValue = 0;
        let y = races.map(r => {
            if (pointsData[r][driver] !== undefined) {
                lastValue = pointsData[r][driver];
            }
            return lastValue;
        });

        traces.push({
            x: races,
            y: y,
            mode: 'lines+markers',
            name: driver
        });
    });

    Plotly.newPlot('points-graph', traces, { 
        title: {
            text: 'Points evolution',
            font: { color: '#ff0000', size: 20, family: 'Segoe UI' }
        },
        xaxis: { 
            title: 'Races',
            titlefont: { color: '#ff0000', size: 16 },
            tickfont: { color: '#e8e8e8', size: 11 },
            tickangle: -45,
            gridcolor: '#333333',
            zeroline: false
        }, 
        yaxis: { 
            title: 'Points',
            titlefont: { color: '#ff0000', size: 16 },
            tickfont: { color: '#e8e8e8', size: 12 },
            gridcolor: '#333333',
            zeroline: false
        },
        plot_bgcolor: '#1a1a1a',
        paper_bgcolor: 'transparent',
        font: { color: '#e8e8e8', family: 'Segoe UI' },
        hovermode: 'closest',
        margin: { l: 55, r: 10, t: 60, b: 150 }
    }, { responsive: true });
}

// Populate pilot statistics table
function displayPilotStats(statsData) {
    const tableDiv = document.getElementById("stats-table");
    let html = "<table><tr><th>Driver</th><th>Wins</th><th>Podiums</th><th>Retirements</th></tr>";
    for (let driver in statsData) {
        let s = statsData[driver];
        html += `<tr>
                    <td>${driver}</td>
                    <td>${s.wins}</td>
                    <td>${s.podiums}</td>
                    <td>${s.retirements}</td>
                 </tr>`;
    }
    html += "</table>";
    tableDiv.innerHTML = html;
}
</script>
</body>
</html>